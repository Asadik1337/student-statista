<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Student Statista</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
    body { font-family: Arial, sans-serif; margin:0; padding:0; background:#f2f2f2; }
    header { background:#1e88e5; padding:15px; color:white; font-size:20px; font-weight:700; text-align:center; }
    #app { padding:15px; }
    .card {
        background:white; padding:15px; border-radius:10px; margin-bottom:15px;
        box-shadow:0 2px 6px rgba(0,0,0,0.12);
    }
    button {
        padding:8px 14px; font-size:14px; border:none; border-radius:5px;
        background:#1e88e5; color:white; cursor:pointer;
    }
    button.secondary { background:#777; }
    button.danger { background:#d32f2f; }
    .task-row {
        display:flex; justify-content:space-between; align-items:center;
        margin:8px 0; padding:8px; background:#f7f7f7; border-radius:6px;
    }
    .green { background:#c8e6c9 !important; }
    .red { background:#ffcdd2 !important; }
    .student-row {
        display:flex; justify-content:space-between; align-items:center;
        padding:6px; background:#f1f1f1; border-radius:5px; margin-top:6px;
    }
    .back-btn {
        background:#555; margin-bottom:10px;
    }
</style>
</head>

<body>
<header>Student Statista</header>
<div id="app"></div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

<!-- Uploadcare (Direct Upload API requires no widget scripts, only this polyfill) -->
<script>
window.UPLOADCARE_PUBLIC_KEY = "452dd8e20a2e77457998";
</script>

<script>

// -------------------------------------------
// FIREBASE CONFIG
// -------------------------------------------
const firebaseConfig = {
  apiKey: "AIzaSyDJDVZazGiEUshVicJX8ObvxIjDPgA5rTo",
  authDomain: "studentstatista.firebaseapp.com",
  databaseURL: "https://studentstatista-default-rtdb.firebaseio.com/",
  projectId: "studentstatista",
  storageBucket: "studentstatista.firebasestorage.app",
  messagingSenderId: "584243573578",
  appId: "1:584243573578:web:59541448a4a8afedf7c7b3"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// -------------------------------------------
// GROUPS + STUDENTS
// -------------------------------------------
const groups = {
"GROUP IELTS M/W/F 9:00": [
"HOSHIMOVA NILUFAR","JURAYEVA AZIZA","MAHMUDOV SUNNAT",
"MUHIDDINOVA MAHBUBA","NORBOYEV SHOHJAXON","OCHILOV LOCHINBEK",
"ORALOVA SHOHINUR","RAVSHANOVA ZAYNAB","TOSHPULATOV ABBOS"
],
"GROUP IELTS 17:00 MWF": [
"ABDURAHIMOVA ZILOLA","ALIMOV BEHRUZ","ANVAROVA RUXSHONA","ASADOV SARDOR",
"BAXRONOVA FAYRUZA","GAFURJONOV ULUGBEK","ISMOILOV ISMOIL","JULIBOYEVA ZEBO",
"KOZIMJONOVA DURDONA","QIZIMELIKUZIYEVA RUXSHONA","NIGMATOV ABDURAHIM",
"RAHMATULLAYEV BEXRUZ","TALABOV SAUD","XISLATULLAYEV JAVOXIR",
"XODJAYEVA LAZIZA","YORMATOV MIRABROR"
],
"GROUP IELTS T/T/S 9:00": [
"SAIDUSMONOVA MADINA","SOBIROVA MARJONA","TILLAYEV OYBEK",
"TOSHTEMIROVA MUBORAK","UMAROVA MOXIGUL"
],
"GROUP IELTS 10:30 TTS": [
"ADXAMOVA MUBINA","BAXTIYOROVA NILUFAR","ISAMATOVA LAYLO",
"NASIROVA LAZIZA","QILICHOVA GULISTON"
],
"GROUP IELTS T/T/S 14:00": [
"ABDUAZIZOVA HABIBA","ABDUJABBOROVA LOLA","ABDUVALIYEVA OMINA",
"ALISHEROV NURMUHAMMAD","DJURAYEVA NURGUL","ISLOMBEKOVA EZOZA",
"ISMAILOVA EZOZA","JORABEKOV AFZALBEK","MAHMUDJONOV FAYZULLOH",
"MIRAHMEDOVA MUSLIMA","OLIMJONOVA DILNURA","TOJIBOYEV MUXAMMAD",
"UROLOV SIROJ","XUDOYBERDIYEV QOSIMBEK"
],
"GROUP IELTS 15:30 TTS":[
"ABUBAKIROVA RAHIMA","IMANKULOVA CHAROS","ISLOMXOJAYEV YUNUS",
"KAYUMKHAJAYEVA JASMINA","MAVLONBEKOV NURMUHAMMAD",
"MIRAXMEDOVA ROBIYA","MIRSAIDOVA MALIKA","MIRSODIQOV MIRABROR",
"QODIROV ABDUVALI","QOSIMOVA NARGIZA","RAVSHANOVA MUSLIMA",
"SHARAXMEDOVA KAMILA","SHERALIYEV ELSHOD","TOGAYEVA SHAXINA",
"UMARXONOVA JAVOHIRPOSHSHA","YOLDASHEVA FARZONA","ZOIRXOJAYEVA ROBIYA"
]
};

// -------------------------------------------
// TASK LIST
// -------------------------------------------
const tasks = [
"Dictation","Reading Test Bank","Podcast","Writing task 1","Writing task 2",
"Speaking Part 1","Speaking Part 2","Speaking Part 3","Listening Strategies",
"Listening Practice","Reading Practice","Listening Made easy","Cambridge Listening",
"Cambridge Reading","Cambridge Writing","TED Podcasts","Vocab for IELTS Book"
];

// -------------------------------------------
// APP STATE
// -------------------------------------------
let currentGroup = null;
let currentStudent = null;
let currentRole = null; // 'teacher','assistant','student'

// -------------------------------------------
// RENDER LOGIN
// -------------------------------------------
function renderLogin(){
    app.innerHTML = "";
    const c = document.createElement("div");
    c.className="card";
    c.innerHTML=`
        <h3>Login</h3>
        <input id="loginUser" placeholder="Username" style="width:100%;padding:8px;margin-bottom:8px;">
        <input id="loginPass" placeholder="Password" type="password" style="width:100%;padding:8px;margin-bottom:8px;">
        <button onclick="doLogin()">Login</button>
    `;
    app.appendChild(c);
}
function doLogin(){
    const u = document.getElementById("loginUser").value;
    const p = document.getElementById("loginPass").value;

    if(u==="Teacher1" && p==="Admin1"){
        currentRole="teacher";
        renderAdmin();
        return;
    }
    if(u==="Assistant1" && p==="Admin2"){
        currentRole="assistant";
        renderAdmin();
        return;
    }
    alert("Invalid credentials.");
}

// -------------------------------------------
// STUDENT INTERFACE
// -------------------------------------------
function renderGroups(){
    app.innerHTML = `<h3>Select your group</h3>`;
    Object.keys(groups).forEach(g=>{
        const d=document.createElement("div");
        d.className="card";
        d.innerHTML=`<b>${g}</b><br><button onclick="selectGroup('${g}')">Open</button>`;
        app.appendChild(d);
    });
}
function selectGroup(g){
    currentGroup=g;
    app.innerHTML = `<button class='back-btn' onclick='renderGroups()'>Back</button>
    <h3>Select your name</h3>`;

    groups[g].forEach(s=>{
        const d=document.createElement("div");
        d.className="card";
        d.innerHTML=`${s}<br><button onclick="selectStudent('${s}')">Open</button>`;
        app.appendChild(d);
    });
}
function selectStudent(s){
    currentStudent=s;
    renderStudentTasks();
}

async function renderStudentTasks(){
    app.innerHTML =
    `<button class='back-btn' onclick='selectGroup("${currentGroup}")'>Back</button>
     <h3>${currentStudent}</h3>
     <h4>Your tasks</h4>`;

    const snap = await db.ref("submissions/"+currentGroup+"/"+currentStudent).get();
    const submitted = snap.exists() ? snap.val() : {};

    tasks.forEach(t=>{
        const row=document.createElement("div");
        row.className="task-row " + (submitted[t] ? "green":"red");
        row.innerHTML = `
            <span>${t}</span>
            <button onclick="uploadTask('${t}')">Submit</button>
        `;
        app.appendChild(row);
    });
}

// -------------------------------------------
// UPLOADCARE DIRECT UPLOAD
// -------------------------------------------
function uploadTask(taskName){
    const input=document.createElement("input");
    input.type="file";
    input.accept="image/*";
    input.onchange=()=>handleUpload(input.files[0],taskName);
    input.click();
}

async function handleUpload(file,taskName){
    if(!file) return;

    const form = new FormData();
    form.append("UPLOADCARE_PUB_KEY","452dd8e20a2e77457998");
    form.append("UPLOADCARE_STORE","auto");
    form.append("file",file);

    const res = await fetch("https://upload.uploadcare.com/base/",{
        method:"POST", body:form
    });

    const data = await res.json();
    if(data.file){
        const url = "https://ucarecdn.com/"+data.file+"/";
        await db.ref("submissions/"+currentGroup+"/"+currentStudent+"/"+taskName)
               .set({url:url, time:Date.now()});
        alert("Uploaded!");
        renderStudentTasks();
    } else {
        alert("Upload failed.");
    }
}

// -------------------------------------------
// ADMIN PANEL
// -------------------------------------------
function renderAdmin(){
    app.innerHTML=`<h3>${currentRole==="teacher"?"Teacher Panel":"Assistant Panel"}</h3>`;
    Object.keys(groups).forEach(g=>{
        const c=document.createElement("div");
        c.className="card";

        c.innerHTML=`<b>${g}</b><br>
            <button onclick="openGroupAdmin('${g}')">Open</button>
            <button onclick="downloadGroupCSV('${g}')" class='secondary'>Export</button>
            ${currentRole==="teacher" ? `<button onclick="clearGroup('${g}')" class="danger">Clear group</button>` : ""}
        `;
        app.appendChild(c);
    });
}

async function openGroupAdmin(g){
    currentGroup=g;
    app.innerHTML =
    `<button class='back-btn' onclick='renderAdmin()'>Back</button>
     <h3>${g}</h3>`;

    const snap = await db.ref("submissions/"+g).get();
    const data = snap.exists() ? snap.val() : {};

    groups[g].forEach(s=>{
        const count = data[s] ? Object.keys(data[s]).length : 0;
        const row=document.createElement("div");
        row.className="student-row";
        row.innerHTML=`
            <div><b>${s}</b><br><small>${count} submitted</small></div>
            <button onclick="viewStudent('${s}')">Open</button>
        `;
        app.appendChild(row);
    });
}

async function viewStudent(s){
    currentStudent=s;
    app.innerHTML =
    `<button class='back-btn' onclick='openGroupAdmin("${currentGroup}")'>Back</button>
     <h3>${s}</h3>`;

    const snap = await db.ref("submissions/"+currentGroup+"/"+s).get();
    const data = snap.exists() ? snap.val() : {};

    tasks.forEach(t=>{
        const row=document.createElement("div");
        row.className="task-row";
        if(data[t]) row.classList.add("green"); else row.classList.add("red");
        row.innerHTML = `
           <span>${t}</span>
           ${data[t] ? `<button onclick="window.open('${data[t].url}','_blank')">View</button>` : ""}
           ${currentRole==="teacher" ? `<button class='danger' onclick="clearTask('${t}')">Delete</button>` : ""}
        `;
        app.appendChild(row);
    });
}

function clearTask(task){
    db.ref("submissions/"+currentGroup+"/"+currentStudent+"/"+task).remove();
    viewStudent(currentStudent);
}

function clearGroup(g){
    if(confirm("Clear all submissions in this group?")){
        db.ref("submissions/"+g).remove();
        alert("Cleared.");
        renderAdmin();
    }
}

function downloadGroupCSV(g){
    const ref=db.ref("submissions/"+g);
    ref.get().then(snap=>{
        const data=snap.exists()?snap.val():{};
        let csv="Student,Task,URL,Time\n";

        Object.keys(data).forEach(st=>{
            Object.keys(data[st]).forEach(task=>{
                csv+=`${st},${task},${data[st][task].url},${data[st][task].time}\n`;
            });
        });

        const blob=new Blob([csv],{type:"text/csv"});
        const url=URL.createObjectURL(blob);
        const a=document.createElement("a");
        a.href=url;
        a.download=g+".csv";
        a.click();
        URL.revokeObjectURL(url);
    });
}

// -------------------------------------------
// START
// -------------------------------------------
renderLogin();

</script>
</body>
</html>
