<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Student Statista</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<!-- Uploadcare Direct Upload -->
<script>
  UPLOADCARE_PUBLIC_KEY = "452dd8e20a2e77457998";
  UPLOADCARE_LOCALE = "en";
  UPLOADCARE_AUTOSTORE = true;
</script>
<script src="https://ucarecdn.com/libs/widget/3.x/uploadcare.full.min.js"></script>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

<style>
body {
  margin:0; font-family:Arial, sans-serif;
  background:#f4f4f4;
}
.header {
  background:#0b7dda; color:white; padding:15px;
  text-align:center; font-size:22px; font-weight:bold;
}
.card {
  background:white; margin:15px; padding:15px;
  border-radius:10px; box-shadow:0 0 8px rgba(0,0,0,0.1);
}
button {
  background:#0b7dda; color:white; padding:10px 14px;
  border:none; border-radius:6px; cursor:pointer; font-size:15px;
}
button.secondary {
  background:#777;
}
button.danger {
  background:#d63434;
}
button.back-btn {
  background:#555;
  margin-bottom:10px;
}
.group-btn, .student-btn {
  display:block; width:100%; text-align:left;
  padding:12px; margin:5px 0; border-radius:8px;
  background:white; border:1px solid #ccc; cursor:pointer;
}
.task-row {
  display:flex; justify-content:space-between;
  background:white; margin:8px 0; padding:10px;
  border-radius:8px; border:1px solid #ccc;
}
.green { background:#d6ffd6; }
.red { background:#ffd6d6; }
</style>
</head>

<body>

<div class="header">Student Statista</div>
<div id="app"></div>

<script>
/* ==========================
   FIREBASE INIT
========================== */
const firebaseConfig = {
  apiKey: "AIzaSyDJDVZazGiEUshVicJX8ObvxIjDPgA5rTo",
  authDomain: "studentstatista.firebaseapp.com",
  projectId: "studentstatista",
  databaseURL: "https://studentstatista-default-rtdb.firebaseio.com/",
  storageBucket: "studentstatista.firebasestorage.app",
  messagingSenderId: "584243573578",
  appId: "1:584243573578:web:59541448a4a8afedf7c7b3",
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* ==========================
   GLOBAL STATE
========================== */
let currentRole = "student";
let currentGroup = null;
let currentStudent = null;

/* ==========================
   GROUPS & STUDENTS
========================== */
const groups = {
"GROUP IELTS M/W/F 9:00": [
"HOSHIMOVA NILUFAR","JURAYEVA AZIZA","MAHMUDOV SUNNAT",
"MUHIDDINOVA MAHBUBA","NORBOYEV SHOHJAXON","OCHILOV LOCHINBEK",
"ORALOVA SHOHINUR","RAVSHANOVA ZAYNAB","TOSHPULATOV ABBOS"
],
"GROUP IELTS 17:00 MWF": [
"ABDURAHIMOVA ZILOLA","ALIMOV BEHRUZ","ANVAROVA RUXSHONA","ASADOV SARDOR",
"BAXRONOVA FAYRUZA","GAFURJONOV ULUGBEK","ISMOILOV ISMOIL","JULIBOYEVA ZEBO",
"KOZIMJONOVA DURDONA","QIZIMELIKUZIYEVA RUXSHONA","NIGMATOV ABDURAHIM",
"RAHMATULLAYEV BEXRUZ","TALABOV SAUD","XISLATULLAYEV JAVOXIR",
"XODJAYEVA LAZIZA","YORMATOV MIRABROR"
],
"GROUP IELTS T/T/S 9:00": [
"SAIDUSMONOVA MADINA","SOBIROVA MARJONA","TILLAYEV OYBEK",
"TOSHTEMIROVA MUBORAK","UMAROVA MOXIGUL"
],
"GROUP IELTS 10:30 TTS": [
"ADXAMOVA MUBINA","BAXTIYOROVA NILUFAR","ISAMATOVA LAYLO",
"NASIROVA LAZIZA","QILICHOVA GULISTON"
],
"GROUP IELTS T/T/S 14:00": [
"ABDUAZIZOVA HABIBA","ABDUJABBOROVA LOLA","ABDUVALIYEVA OMINA",
"ALISHEROV NURMUHAMMAD","DJURAYEVA NURGUL","ISLOMBEKOVA EZOZA",
"ISMAILOVA EZOZA","JORABEKOV AFZALBEK","MAHMUDJONOV FAYZULLOH",
"MIRAHMEDOVA MUSLIMA","OLIMJONOVA DILNURA","TOJIBOYEV MUXAMMAD",
"UROLOV SIROJ","XUDOYBERDIYEV QOSIMBEK"
],
"GROUP IELTS 15:30 TTS": [
"ABUBAKIROVA RAHIMA","IMANKULOVA CHAROS","ISLOMXOJAYEV YUNUS",
"KAYUMKHAJAYEVA JASMINA","MAVLONBEKOV NURMUHAMMAD",
"MIRAXMEDOVA ROBIYA","MIRSAIDOVA MALIKA","MIRSODIQOV MIRABROR",
"QODIROV ABDUVALI","QOSIMOVA NARGIZA","RAVSHANOVA MUSLIMA",
"SHARAXMEDOVA KAMILA","SHERALIYEV ELSHOD","TOGAYEVA SHAXINA",
"UMARXONOVA JAVOHIRPOSHSHA","YOLDASHEVA FARZONA","ZOIRXOJAYEVA ROBIYA"
]
};

/* ==========================
   TASK LIST
========================== */
const tasks = [
"Dictation","Reading Test Bank","Podcast","Writing task 1","Writing task 2",
"Speaking Part 1","Speaking Part 2","Speaking Part 3","Listening Strategies",
"Listening Practice","Reading Practice","Listening Made easy",
"Cambridge Listening","Cambridge Reading","Cambridge Writing",
"TED Podcasts","Vocab for IELTS book"
];

/* ==========================
   LOGIN SCREEN
========================== */
function renderLogin(){
  app.innerHTML = "";
  const c=document.createElement("div");
  c.className="card";
  c.innerHTML=`
    <h3>Login</h3>
    <input id="loginUser" placeholder="Username" style="width:100%;padding:10px;margin-bottom:10px"/>
    <input id="loginPass" placeholder="Password" type="password" style="width:100%;padding:10px;margin-bottom:10px"/>

    <button onclick="doLogin()" style="width:100%;margin-bottom:10px;">Login</button>
    <button class="secondary" onclick="renderGroups()" style="width:100%;">Login as Student</button>

    <div style="margin-top:10px;font-size:13px;color:#444;">
      Students do not need a password. Click "Login as Student".
    </div>
  `;
  app.appendChild(c);
}

/* ==========================
   DO LOGIN (TEACHER / ASSISTANT)
========================== */
function doLogin(){
  const u=document.getElementById("loginUser").value.trim();
  const p=document.getElementById("loginPass").value.trim();

  if(u==="Teacher1" && p==="Admin1"){
    currentRole="teacher";
    renderAdmin();
    return;
  }
  if(u==="Assistant1" && p==="Admin2"){
    currentRole="assistant";
    renderAdmin();
    return;
  }
  alert("Invalid credentials");
}

/* ==========================
   RENDER GROUPS (STUDENT MODE)
========================== */
function renderGroups(){
  currentRole="student";
  app.innerHTML = "<h3>Select your group</h3>";

  for(let g in groups){
    const b=document.createElement("button");
    b.className="group-btn";
    b.textContent=g;
    b.onclick=()=>selectGroup(g);
    app.appendChild(b);
  }
}

/* ==========================
   SELECT GROUP / STUDENT
========================== */
function selectGroup(g){
  currentGroup=g;
  app.innerHTML=`<button class='back-btn' onclick='renderGroups()'>Back</button><h3>${g}</h3>`;

  groups[g].forEach(st=>{
    const btn=document.createElement("button");
    btn.className="student-btn";
    btn.textContent=st;
    btn.onclick=()=>{ currentStudent=st; renderStudentTasks(); };
    app.appendChild(btn);
  });
}

/* ==========================
   STUDENT TASK VIEW
========================== */
async function renderStudentTasks(){
  app.innerHTML=
  `<button class='back-btn' onclick='selectGroup("${currentGroup}")'>Back</button>
   <h3>${currentStudent}</h3><h4>Your tasks</h4>`;

  let submitted={};
  try{
    const snap=await db.ref("submissions/"+currentGroup+"/"+currentStudent).get();
    submitted=snap.exists()?snap.val():{};
  }catch(e){ submitted={}; }

  tasks.forEach(t=>{
    const done = submitted[t];
    const row=document.createElement("div");
    row.className="task-row "+(done?"green":"red");
    row.innerHTML = `
      <span>${t}</span>
      <div>
        ${done? `<button onclick="window.open('${done.url}','_blank')">View</button>` : ``}
        <button onclick="uploadTask('${t}')">${done?"Resubmit":"Submit"}</button>
      </div>
    `;
    app.appendChild(row);
  });
}

/* ==========================
   UPLOAD TASK (UPLOADCARE)
========================== */
async function uploadTask(taskName){
  const file = await uploadcare.openDialog().done(f=>f);
  const info = await file.promise();

  await db.ref("submissions/"+currentGroup+"/"+currentStudent+"/"+taskName)
    .set({
      url:info.cdnUrl,
      time:Date.now()
    });

  alert("Uploaded successfully!");
  renderStudentTasks();
}

/* ==========================
   ADMIN PANEL
========================== */
function renderAdmin(){
  app.innerHTML =
  `<button class='back-btn' onclick='renderLogin()'>Logout</button>
   <h3>Admin Panel (${currentRole})</h3>
   <h4>Select a group</h4>`;

  for(let g in groups){
    const b=document.createElement("button");
    b.className="group-btn";
    b.textContent=g;
    b.onclick=()=>openGroupAdmin(g);
    app.appendChild(b);
  }
}

/* ==========================
   ADMIN: OPEN GROUP
========================== */
async function openGroupAdmin(g){
  currentGroup=g;
  app.innerHTML=
  `<button class='back-btn' onclick='renderAdmin()'>Back</button>
   <h3>${g}</h3>`;

  let data={};
  try{
    const snap=await db.ref("submissions/"+g).get();
    data=snap.exists()?snap.val():{};
  }catch(e){ data={}; }

  groups[g].forEach(st=>{
    const count = data[st]? Object.keys(data[st]).length : 0;
    const row=document.createElement("div");
    row.className="task-row";
    row.innerHTML=`
      <span><b>${st}</b><br><small>${count} submitted</small></span>
      <div>
        <button onclick="viewStudent('${st}')">Open</button>
        <button class="secondary" onclick="downloadStudentCSV('${g}','${st}')">Export</button>
      </div>
    `;
    app.appendChild(row);
  });

  app.innerHTML+=`
    <button class="danger" style="margin-top:15px;"
      onclick="downloadGroupCSV('${g}')">Export whole group</button>

    ${currentRole==="teacher" ?
      `<button class="danger" style="margin-left:10px"
          onclick="clearGroup('${g}')">Clear group</button>` : ""}
  `;
}

/* ==========================
   VIEW STUDENT (ADMIN)
========================== */
async function viewStudent(st){
  currentStudent=st;
  app.innerHTML=
  `<button class='back-btn' onclick='openGroupAdmin("${currentGroup}")'>Back</button>
   <h3>${st}</h3>`;

  let data={};
  try{
    const snap=await db.ref("submissions/"+currentGroup+"/"+st).get();
    data=snap.exists()?snap.val():{};
  }catch(e){ data={}; }

  tasks.forEach(t=>{
    const rec=data[t];
    const row=document.createElement("div");
    row.className="task-row "+(rec?"green":"red");
    row.innerHTML=`
      <span>${t}</span>
      <div>
        ${rec? `<button onclick="window.open('${rec.url}','_blank')">View</button>` : ""}
        ${currentRole==="teacher" ? `<button class='danger' onclick="clearTask('${t}')">Delete</button>` : ""}
      </div>
    `;
    app.appendChild(row);
  });
}

/* ==========================
   CLEAR TASK (ADMIN)
========================== */
async function clearTask(t){
  await db.ref("submissions/"+currentGroup+"/"+currentStudent+"/"+t).remove();
  viewStudent(currentStudent);
}

/* ==========================
   CLEAR GROUP (TEACHER)
========================== */
async function clearGroup(g){
  if(!confirm("Are you sure?")) return;
  await db.ref("submissions/"+g).remove();
  openGroupAdmin(g);
}

/* ==========================
   EXPORT STUDENT CSV
========================== */
async function downloadStudentCSV(g,st){
  let data={};
  try{
    const snap=await db.ref("submissions/"+g+"/"+st).get();
    data=snap.exists()?snap.val():{};
  }catch(e){ data={}; }

  let csv="Task,Submitted,URL,Time\n";
  tasks.forEach(t=>{
    const rec=data[t];
    csv+=`${t},${rec?"yes":"no"},${rec?rec.url:""},${rec?new Date(rec.time).toLocaleString():""}\n`;
  });

  const blob=new Blob([csv],{type:"text/csv"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url;
  a.download=`${st.replace(/ /g,"_")}.csv`;
  a.click();
  URL.revokeObjectURL(url);
}

/* ==========================
   EXPORT WHOLE GROUP CSV
========================== */
async function downloadGroupCSV(g){
  let data={};
  try{
    const snap=await db.ref("submissions/"+g).get();
    data=snap.exists()?snap.val():{};
  }catch(e){ data={}; }

  let csv="Student,Task,Submitted,URL,Time\n";

  groups[g].forEach(st=>{
    const stData=data[st]||{};
    tasks.forEach(task=>{
      const rec=stData[task];
      csv+=`${st},${task},${rec?"yes":"no"},${rec?rec.url:""},${rec?new Date(rec.time).toLocaleString():""}\n`;
    });
  });

  const blob=new Blob([csv],{type:"text/csv"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url;
  a.download=`${g.replace(/ /g,"_")}.csv`;
  a.click();
  URL.revokeObjectURL(url);
}

/* ==========================
   DEFAULT SCREEN
========================== */
renderLogin();

</script>
</body>
</html>
