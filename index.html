<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Statista</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>

<style>
body{ margin:0; font-family:Arial; background:#f4f6fb; }
header{background:#1e88e5;color:#fff;padding:15px;text-align:center;font-size:20px;position:relative;}
.container{max-width:1200px;margin:20px auto;padding:10px}
.card{background:#fff;border-radius:8px;padding:15px;margin-bottom:12px}
button{padding:8px 14px;border:none;border-radius:6px;cursor:pointer}
.primary{background:#1e88e5;color:white}
.secondary{background:#777;color:white}
.danger{background:#c62828;color:white}
.back{background:#555;color:white;margin-bottom:10px}
.green{color:#2e7d32;font-weight:bold}
.red{color:#c62828;font-weight:bold}
.stage{margin-left:0}
.lesson{margin-left:20px}
.hw{margin-left:40px}
img{max-width:120px;border-radius:6px;margin-top:6px}
input[type=file]{display:none}

#webviewWarning{
  display:none;
  position: sticky;
  top: 0;
  z-index: 9999;
  background: #fff3cd;
  color: #856404;
  padding: 10px 14px;
  font-size: 13px;
  text-align: center;
  border-bottom: 1px solid #ffeeba;
}

#helpBtn{
  position:absolute;
  top:50%;
  right:16px;
  transform:translateY(-50%);
  background:#fff;
  color:#1e88e5;
  border:2px solid #1e88e5;
  padding:6px 12px;
  border-radius:8px;
  font-size:13px;
  cursor:pointer;
  box-shadow:0 2px 6px rgba(0,0,0,.15);
  z-index: 99999;
}
#helpBtn:hover{ background:#1e88e5; color:#fff; }
</style>
</head>

<body>

<header>
  Statista
  <div id="helpBtn" onclick="openInstruction()">üìòInstructions</div>
</header>

<div id="webviewWarning">
  ‚ö†Ô∏è –î–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ –æ—Ç–∫—Ä–æ–π—Ç–µ —Å–∞–π—Ç –≤ –±—Ä–∞—É–∑–µ—Ä–µ:
  <b>‚ãÆ ‚Üí Open in Chrome / Safari</b>
</div>

<div class="container" id="app"></div>

<script>
/* ================= FIREBASE ================= */
firebase.initializeApp({
  apiKey: "AIzaSyDJDVZazGiEUshVicJX8ObvxIjDPgA5rTo",
  authDomain: "studentstatista.firebaseapp.com",
  databaseURL: "https://studentstatista-default-rtdb.firebaseio.com",
  projectId: "studentstatista",
  storageBucket: "studentstatista.firebasestorage.app"
});
const db = firebase.database();
const storage = firebase.storage();

(function detectWebView(){
  const ua = navigator.userAgent.toLowerCase();
  const isWebView =
    ua.includes("wv") ||
    ua.includes("telegram") ||
    ua.includes("instagram") ||
    (ua.includes("android") && !ua.includes("chrome"));

  if (isWebView) {
    const bar = document.getElementById("webviewWarning");
    if (bar) bar.style.display = "block";
  }
})();

/* ================= ‚úÖ ADDED: NAV STATE (to stop resetting to home) ================= */
const NAV_KEY = "statista_nav_v1";
function setNav(view, payload){
  try{
    localStorage.setItem(NAV_KEY, JSON.stringify({ view, payload, t: Date.now() }));
  }catch(e){}
}
function getNav(){
  try{
    const raw = localStorage.getItem(NAV_KEY);
    return raw ? JSON.parse(raw) : null;
  }catch(e){ return null; }
}
function clearNav(){
  try{ localStorage.removeItem(NAV_KEY); }catch(e){}
}
function restoreNavOrHome(){
  const nav = getNav();
  if(!nav || !nav.view){ home(); return; }

  // –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —ç–∫—Ä–∞–Ω–∞
  try{
    if(nav.view === "home") return home();
    if(nav.view === "enterStudent") return enterStudent();
    if(nav.view === "selectStudent") return selectStudent(nav.payload.group);
    if(nav.view === "showStages") return showStages(nav.payload.group, nav.payload.student);
    if(nav.view === "showLessons") return showLessons(nav.payload.group, nav.payload.student, nav.payload.stage);
    if(nav.view === "showHomework") return showHomework(nav.payload.group, nav.payload.student, nav.payload.stage, nav.payload.lesson);
    if(nav.view === "instructions") return openInstruction();

    if(nav.view === "admin") return admin();
    if(nav.view === "adminGroup") return adminGroup(nav.payload.group);
    if(nav.view === "adminStageSelect") return adminStageSelect(nav.payload.group, nav.payload.stage);
    if(nav.view === "adminLessonView") return adminLessonView(nav.payload.group, nav.payload.stage, nav.payload.lesson);

    // –µ—Å–ª–∏ —á—Ç–æ-—Ç–æ –Ω–µ —Å–æ–≤–ø–∞–ª–æ
    home();
  }catch(e){
    home();
  }
}

/* ================= GROUPS ================= */
const GROUPS = {
  "GROUP IELTS 9:00 M/W/F":[
    "HOSHIMOVA NILUFAR","JURAYEVA AZIZA","MAHMUDOV SUNNAT","MUHIDDINOVA MAHBUBA",
    "NORBOYEV SHOHJAXON","OCHILOV LOCHINBEK","ORALOVA SHOHINUR",
    "RAVSHANOVA ZAYNAB","TOSHPULATOV ABBOS"
  ],
  "GROUP IELTS 17:00 MWF":[
    "ABDURAHIMOVA ZILOLA","ALIMOV BEHRUZ","ANVAROVA RUXSHONA","ASADOV SARDOR",
    "BAXRONOVA FAYRUZA","GAFURJONOV ULUGBEK","ISMOILOV ISMOIL",
    "JULIBOYEVA ZEBO","KOZIMJONOVA DURDONA","MELIKUZIYEVA RUXSHONA",
    "NIGMATOV ABDURAHIM","RAHMATULLAYEV BEXRUZ","TALABOV SAUD",
    "XISLATULLAYEV JAVOXIR","XODJAYEVA LAZIZA","YORMATOV MIRABROR"
  ],
  "GROUP IELTS M/W/F 14:00":[
    "RASHIDJANOVA FARANGIZ","RUZIYEVA GAVHAR","YADGARALIYEVA GULHAYO",
    "MUHAMMADIYEVA SEVINCH","KHUDOYBERDIYEVA LAZIZA","ODIL RAZZOQOV"
  ],

  "GROUP IELTS T/T/S 9:00":[
    "ZARINA FAYZULLAEVA","MURODOVA NOZIMA","AZIZA ERKINOVA","NURIDDIN QOCHQOROV",
    "QIDIRALIEVA JAYNA","HAMROYEVA NIGORA","QILICHOVA GULISTON"
  ],

  "GROUP IELTS 10:30 TTS":[
    "ADXAMOVA MUBINA","BAXTIYOROVA NILUFAR",
    "ISAMATOVA LAYLO","NOSIROVA LAZIZA"
  ],
  "GROUP IELTS T/T/S 14:00":[
    "ABDUAZIZOVA HABIBA","ABDUJABBOROVA LOLA","ABDUVALIYEVA OMINA",
    "ALISHEROV NURMUHAMMAD","DJURAYEVA NURGUL","ISLOMBEKOVA EZOZA",
    "ISMAILOVA EZOZA","JORABEKOV AFZALBEK","MAHMUDJONOV FAYZULLOH",
    "MIRAHMEDOVA MUSLIMA","OLIMJONOVA DILNURA","TOJIBOYEV MUXAMMAD",
    "UROLOV SIROJ","XUDOYBERDIYEV QOSIMBEK","SHODIYEVA ROBIYA","ABDULXAMIDOV DILYORBEK",
    "KAYUMXODJAYEVA JASMINA","MIRSIDIQOV MIRABROR"
  ],
  "GROUP IELTS 15:30 TTS":[
    "KAMILA SHARAXMEDOVA","FAYZULLAYEVA HILOLA","MUSTAFOYEVA SEVINCH","SOBIRJONOVA DURDONA",
    "MIRVALIEVA XADICHA","ABDURAHMONOVA EZOZA","QODIRJANOVA RUSHANA","AMETOV UMIRBEK","SULTANBEKOVA LAZIZA",
    "MIRFOTIHOVA HADICHA","ZOHIDOV ASILBEK","TOXIROV AYUBHON","SHAVKATOV HUSAN","MELIKUZIEVA FARZONA",
    "SULTONOVA MUSLIMA","ABDUGANIEVA MOXINUR","SHAVKATOV KHASAN","URALOVA MUXLISA","TOSHXOJAYEV ISROILXOJA",
    "AXMADJONOV DONIYOR","XASANOV JAHONGIR","UMARALIYEV OYATILLO"
  ],
  "GROUP IELTS T/T/S 18:30":[
    "ABDULAZIZOV ASADULLO","ABDULAZIZOVA MUHLISA","ABDURAZZOQOVA MUBORAK",
    "GANIJONOV AZIZBEK","HAMIDJONOV ABDULMALIK","IBROHIMOV JASURBEK","JURABOYEVA ZEBINISO",
    "KARIMOVA AZIZAXON","OLIMJONOV ABDUGAFFOR","RAXMATULAYEVA ROZITYA","SHOKIROV ABDURAZZOQ",
    "ULMASOV DALER","ZAHRIDDINOV FAZLIDDIN","MIRZABOYEVA ROZYA","XUSHNAZAROV TEMUR","DAVLATBEK JORAYEV",
    "SOPORBOYEVA KAMOLA","DAYNOVOVA ZEBINISO","JURAYEV KAMRON","TIMUR ABDUSADIKOV"
  ]
};
  
/* ================= STAGES ================= */
const STAGES = {
  "STAGE 1 - WRITING TASK 1": { /* ... (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ... */ 
    "LESSON 1": ["Dictation 1-3","Reading Test Bank Updated 1-3","New Podcasts 1-4","Writing Task 1 (3 graphs - introduction & overview)","Vocabulary for Test Bank (Learn)","Speaking: Work or Study"],
    "LESSON 2": ["Dictation 4-6","Reading Test Bank Updated 4-6","New Podcasts 5-8","Writing Task 1 (Full report)","Vocabulary for Test Bank (Learn)","Speaking: Hometown"],
    "LESSON 3": ["Dictation 7-9","Reading Test Bank Updated 7-9","New Podcasts 9-12","Writing Task 1 (Full report)","Vocabulary for Test Bank (Learn)","Speaking: Home"],
    "LESSON 4": ["Dictation 10-12","Reading Test Bank Updated 10-12","New Podcasts 13-16","Writing Task 1 (Report 5-6 full)","Vocabulary for Test Bank (Learn)","Speaking: Social Media"],
    "LESSON 5": ["Dictation 13-15","Reading Test Bank Updated 13-15","New Podcasts 17-20","Writing Task 1 (Report 7-8 full)","Vocabulary for Test Bank (Learn)","Speaking: Colors"],
    "LESSON 6": ["Dictation 16-18","Reading Test Bank Updated 16-18","New Podcasts 21-24","Writing Task 1 (Full report)","Vocabulary for Test Bank (Learn)","Speaking: Music"],
    "LESSON 7": ["Dictation 19-21","Reading Test Bank Updated 19-21","New Podcasts 25-28","Writing Task 1 (Full report)","Vocabulary for Test Bank (Learn)","Speaking: Food"],
    "LESSON 8": ["Dictation 22-24","Reading Test Bank Updated 22-24","New Podcasts 29-32","Vocabulary for Test Bank (Learn)","Writing Report","Speaking: Shopping"],
    "LESSON 9": ["Dictation 25-27","Reading Test Bank Updated 25-27","New Podcasts 33-36","Vocabulary for Test Bank (Learn)","Writing Task 1","Speaking: Sport"]
  },
  "STAGE 2 - LISTENING": { /* ... */ 
    "LESSON 1":["Listening Strategies Unit 1","Listening Practice Lesson 1","Reading Practice Lesson 1","Spelling Dictation (Pages 2-3)","Task 1 Editing (Rewriting)","Speaking: Shopping"],
    "LESSON 2":["Listening Strategies Unit 2","Listening Practice Lesson 2","Reading Practice Lesson 2","Spelling Dictation (All pages)","Listening Made Easy","Task 1 (Rewriting)","Speaking: Morning routine"],
    "LESSON 3":["Listening Strategies Unit 3","Listening Practice Lesson 3","Reading Practice Lesson 3","Spelling Dictation","Listening Made Easy","Task 1 (Rewriting)","Speaking: News"],
    "LESSON 4":["Listening Strategies Unit 4","Listening Practice Lesson 4","Reading Practice Lesson 4","Spelling Dictation","Listening Made Easy","Task 1 (Rewriting)","Speaking: Sharing things"],
    "LESSON 5":["Listening Strategies Unit 5","Listening Practice Lesson 5","Reading Practice Lesson 5","Spelling Dictation"]
  },
  "STAGE 3 - READING": { /* ... */ 
    "LESSON 1":["Cambridge 10 Test 1 (L/R) + deep analysis","TED Radio Hour (Where Joy Hides?) Part 1","Shadowing Video","Articles"],
    "LESSON 2":["Cambridge 10 Test 2 (L/R) + deep analysis","TED Radio Hour (Where Joy Hides?) Part 2","Task 1 report review","Articles"],
    "LESSON 3":["Cambridge 10 Test 3 (L/R) + deep analysis","TED Radio Hour (Quiet) Part 1","Shadowing Video","Articles"],
    "LESSON 4":["Cambridge 10 Test 4 (L/R) + deep analysis","TED Radio Hour (Quiet) Part 2","Task 1 report review","Articles"],
    "LESSON 5":["Cambridge 11 Test 1 (L/R) + deep analysis","TED Radio Hour (The Food We Eat) Part 1","Shadowing Video","Articles"],
    "LESSON 6":["Cambridge 11 Test 2 (L/R) + deep analysis","TED Radio Hour (The Food We Eat) Part 2","Task 1 report review","Articles"],
    "LESSON 7":["Cambridge 11 Test 3 (L/R) + deep analysis","TED Radio Hour (The Five Senses) Part 1","Shadowing Video","Articles"],
    "LESSON 8":["Cambridge 11 Test 4 (L/R) + deep analysis","TED Radio Hour (The Five Senses) Part 2","Task 1 new report","Articles"],
    "LESSON 9":["Cambridge 12 Test 1 (L/R) + deep analysis","TED Radio Hour (The Power Of Design) Part 1","Shadowing Video","Articles"],
    "LESSON 10":["Cambridge 12 Test 2 (L/R) + deep analysis","TED Radio Hour (The Power Of Design) Part 2","Task 1 new report","Articles"]
  },
  "STAGE 4 - WRITING TASK 2 AND SPEAKING": { /* ... */ 
    "LESSON 1":["Cambridge 12 Test 3 (L/R) + deep analysis","TED Radio Hour (Making Mistakes) Part 1","Speaking Part 2 + Part 3","Articles"],
    "LESSON 2":["Cambridge 12 Test 4 (L/R) + deep analysis","TED Radio Hour (Making Mistakes) Part 2","Speaking Part 2 + Part 3","Articles","Opinion Essay"],
    "LESSON 3":["Cambridge 13 Test 1 (L/R) + deep analysis","TED Radio Hour (Rethinking School) Part 1","Speaking Part 2 + Part 3","Articles","Discussion Essay"],
    "LESSON 4":["Cambridge 13 Test 2 (L/R) + deep analysis","TED Radio Hour (Rethinking School) Part 2","Speaking Part 2 + Part 3","Articles","Advantages / Disadvantages Essay"],
    "LESSON 5":["Cambridge 13 Test 3 (L/R) + deep analysis","TED Radio Hour (Overcoming)","Speaking Part 2 + Part 3","Articles","Issue Discussion Essay"],
    "LESSON 6":["Cambridge 13 Test 4 (L/R) + deep analysis","TED Radio Hour (Networks) Part 1","Speaking Part 2 + Part 3","Articles","Mixed / Direct Essays"],
    "LESSON 7":["Cambridge 14 Test 1 (L/R) + deep analysis","TED Radio Hour (Networks) Part 2","Speaking Part 2 + Part 3","Articles","Direct Essay"],
    "LESSON 8":["Cambridge 14 Test 2 (L/R/W) + deep analysis","TED Radio Hour (From Curiosity To Discovery) Part 1","Speaking Part 2 + Part 3","Articles"],
    "LESSON 9":["Cambridge 14 Test 3 (L/R/W) + deep analysis","TED Radio Hour (From Curiosity To Discovery) Part 2","Speaking Part 2 + Part 3","Articles"],
    "LESSON 10":["Cambridge 14 Test 4 (L/R/W) + deep analysis","TED Radio Hour (Comfort Zone) Part 1","Speaking Part 2 + Part 3","Articles"],
    "LESSON 11":["Cambridge 15 Test 1 (L/R/W) + deep analysis","TED Radio Hour (Comfort Zone) Part 2","Speaking Part 2 + Part 3","Articles"],
    "LESSON 12":["Cambridge 15 Test 2 (L/R/W) + deep analysis","TED Radio Hour (Money Paradox) Part 1","Speaking Part 2 + Part 3","Articles"]
  },
  "STAGE 5 - POLISHING SKILLS": {
    "LESSON 1":["Full Listening x1","Full Reading x1","Article reading","1 hour podcast","Writing Task 1","Speaking Practice","Vocabulary for IELTS","ELS Upper Intermediate"],
    "LESSON 2":["Full Listening x1","Full Reading x1","Article reading","1 hour podcast","Writing Task 2","Speaking Practice","Vocabulary for IELTS","ELS Upper Intermediate"],
    "LESSON 3":["Full Listening x1","Full Reading x1","Article reading","1 hour podcast","Writing Task 1","Speaking Practice","Vocabulary for IELTS","ELS Upper Intermediate"],
    "LESSON 4":["Full Listening x1","Full Reading x1","Article reading","1 hour podcast","Writing Task 2","Speaking Practice","Vocabulary for IELTS","ELS Upper Intermediate"],
    "LESSON 5":["Full Listening x1","Full Reading x1","Article reading","1 hour podcast","Writing Task 1","Speaking Practice","Vocabulary for IELTS","ELS Upper Intermediate"],
    "LESSON 6":["Full Listening x1","Full Reading x1","Article reading","1 hour podcast","Writing Task 2","Speaking Practice","Vocabulary for IELTS","ELS Upper Intermediate"],
    "LESSON 7":["Full Listening x1","Full Reading x1","Article reading","1 hour podcast","Writing Task 1","Speaking Practice","Vocabulary for IELTS","ELS Upper Intermediate"],
    "LESSON 8":["Full Listening x1","Full Reading x1","Article reading","1 hour podcast","Writing Task 2","Speaking Practice","Vocabulary for IELTS","ELS Upper Intermediate"],
    "LESSON 9":["Full Listening x1","Full Reading x1","Article reading","1 hour podcast","Writing Task 1","Speaking Practice","Vocabulary for IELTS","ELS Upper Intermediate"],
    "LESSON 10":["Full Listening x1","Full Reading x1","Article reading","1 hour podcast","Writing Task 2","Speaking Practice","Vocabulary for IELTS","ELS Upper Intermediate"],
    "LESSON 11":["Full Listening x1","Full Reading x1","Article reading","1 hour podcast","Writing Task 1","Speaking Practice","Vocabulary for IELTS","ELS Upper Intermediate"],
    "LESSON 12":["Full Listening x1","Full Reading x1","Article reading","1 hour podcast","Writing Task 2","Speaking Practice","Vocabulary for IELTS","ELS Upper Intermediate"]
  },
  "STAGE 6 - FINAL PRACTICE": {
    "LESSON 1":["Listening full","Reading full","Article - new words","Article ELS (pages 312-315)","Task 1","Speaking","Cambridge 19 - test 1","Longer Article","Grammar revision lesson 1"],
    "LESSON 2":["Listening full","Reading full","Article - new words","Article ELS (pages 316-319)","Task 2","Speaking","Cambridge 19 - test 2","Longer Article","Grammar revision lesson 2"],
    "LESSON 3":["Listening full","Reading full","Article - new words","Article ELS (pages 320-323)","Task 1","Speaking","Cambridge 19 - test 3","Longer Article","Grammar revision lesson 3"],
    "LESSON 4":["Listening full","Reading full","Article - new words","Article ELS (pages 324-327)","Task 2","Speaking","Cambridge 19 - test 4","Longer Article","Grammar revision lesson 4"],
    "LESSON 5":["Listening full","Reading full","Article - new words","Article ELS (pages 328-331)","Task 1","Speaking","Cambridge 20 - test 1","Longer Article","Grammar revision lesson 5"],
    "LESSON 6":["Listening full","Reading full","Article - new words","Article ELS (pages 332-335)","Task 2","Speaking","Cambridge 20 - test 2","Longer Article","Grammar revision lesson 6"],
    "LESSON 7":["Listening full","Reading full","Article - new words","Article ELS (pages 336-339)","Task 1","Speaking","Cambridge 20 - test 3","Longer Article","Grammar revision lesson 7"],
    "LESSON 8":["Listening full","Reading full","Article - new words","Article ELS (pages 340-343)","Task 2","Speaking","Cambridge 20 - test 4","Longer Article","Grammar revision lesson 8"],
    "LESSON 9":["Listening full","Reading full","Article - new words","Article ELS (pages 344-347)","Task 1","Speaking","Volume 7 - Test 1","Longer Article"],
    "LESSON 10":["Listening full","Reading full","Article - new words","Article ELS (pages 348-351)","Task 2","Speaking","Volume 7 - Test 2","Longer Article"],
    "LESSON 11":["Listening full","Reading full","Article - new words","Article ELS (pages 352-355)","Task 1","Speaking","Volume 7 - Test 3","Longer Article"],
    "LESSON 12":["Listening full","Reading full","Article - new words","Article ELS (pages 356-359)","Task 2","Speaking","Volume 7 - Test 4","Longer Article"]
  }
};

/* ================= APP ================= */
const app=document.getElementById("app");

function openInstruction(){
  setNav("instructions", {});
  app.innerHTML = `
    <button class="back" onclick="home()">Back</button>
    <h2>üìò Student-Friendly Instructions: How to Use the Website</h2>

    <div class="card"><b>Step 1</b><br>
      When you open the website, click <b>‚ÄúEnter as Student‚Äù</b>.
    </div>

    <div class="card"><b>Step 2</b><br>
      Find your <b>group</b> and click on it.
      After that, find your <b>full name</b> in the list and click on it.
    </div>

    <div class="card"><b>Step 3</b><br>
      You will see <b>5 stages</b>.
      Click the stage you are currently studying, then choose the <b>lesson</b> and the <b>homework</b> you need to submit.
    </div>

    <div class="card"><b>Step 4</b><br>
      Attach <b>at least one photo</b> of your homework and submit it.<br><br>
      ‚ö†Ô∏è <b>Without a photo, the homework will NOT be saved and will NOT be marked as ‚ÄúSubmitted‚Äù.</b>
    </div>

    <div class="card"><b>üìå Important Note</b><br>
      For <b>Speaking homework</b>:
      <ul>
        <li>Send your speaking to the group (as usual)</li>
        <li>Take a screenshot of it</li>
        <li>Upload the screenshot to the website</li>
      </ul>
    </div>

    <div class="card"><b>‚úÖ Final Reminder</b><br>
      After submitting, always check that the homework status shows <b>‚ÄúSubmitted‚Äù</b>.
    </div>
  `;
}

/* ================= HOME ================= */
function home(){
  setNav("home", {});
  app.innerHTML=`
    <div class="card"><button class="primary" onclick="enterStudent()">Enter as Student</button></div>
    <div class="card"><button class="primary" onclick="login()">Teacher / Assistant</button></div>
  `;
}

/* ================= STUDENT FLOW ================= */
function enterStudent(){
  setNav("enterStudent", {});
  let h=`<button class="back" onclick="home()">Back</button><h3>Select Group</h3>`;
  Object.keys(GROUPS).forEach(g=>{
    h+=`<div class="card"><button class="primary" onclick="selectStudent('${g}')">${g}</button></div>`;
  });
  app.innerHTML=h;
}

function selectStudent(group){
  setNav("selectStudent", { group });
  let h=`<button class="back" onclick="enterStudent()">Back</button><h3>${group}</h3>`;
  GROUPS[group].forEach(s=>{
    h+=`<div class="card"><button class="primary" onclick="showStages('${group}','${s}')">${s}</button></div>`;
  });
  app.innerHTML=h;
}

function showStages(group,student){
  setNav("showStages", { group, student });
  let h=`<button class="back" onclick="selectStudent('${group}')">Back</button><h3>${student}</h3>`;
  Object.keys(STAGES).forEach(stage=>{
    h+=`<div class="card stage"><button class="primary" onclick="showLessons('${group}','${student}','${stage}')">${stage}</button></div>`;
  });
  app.innerHTML=h;
}

function showLessons(group,student,stage){
  setNav("showLessons", { group, student, stage });
  let h=`<button class="back" onclick="showStages('${group}','${student}')">Back</button><h3>${stage}</h3>`;
  Object.keys(STAGES[stage]).forEach(lesson=>{
    h+=`<div class="card lesson"><button class="secondary" onclick="showHomework('${group}','${student}','${stage}','${lesson}')">${lesson}</button></div>`;
  });
  app.innerHTML=h;
}

async function showHomework(group, student, stage, lesson){
  setNav("showHomework", { group, student, stage, lesson });

  const lessonSnap = await db
    .ref(`submissions/${group}/${student}/${stage}/${lesson}`)
    .once("value");
  const lessonData = lessonSnap.val() || {};

  let h = `
    <button class="back" onclick="showLessons('${group}','${student}','${stage}')">Back</button>
    <h3>${stage} / ${lesson}</h3>
  `;

  for (const hw of STAGES[stage][lesson]) {
    const d = lessonData[hw];
    const submitted = d && Array.isArray(d.files) && d.files.length > 0;

    h += `
      <div class="card hw">
        <b>${hw}</b><br>
        <span class="${submitted ? 'green' : 'red'}">
          ${submitted ? 'Submitted' : 'Not submitted'}
        </span><br>
        ${
          submitted ? d.files.map(url => `<img src="${url}" />`).join("") : ''
        }
        <br>

        <label class="primary">
          Submit photo (max 4)
          <input type="file" accept="image/*" multiple
            onchange="submitHW(this,'${group}','${student}','${stage}','${lesson}','${hw}')">
        </label>

        ${
          submitted ? `
            <label class="danger" style="display:inline-block;margin-left:8px;">
              Replace photos
              <input type="file" accept="image/*" multiple
                onchange="replaceHW(this,'${group}','${student}','${stage}','${lesson}','${hw}')">
            </label>
          ` : ''
        }

      </div>
    `;
  }

  app.innerHTML = h;
}

function safe(v) {
  return String(v).replace(/[^a-zA-Z0-9_-]/g, "_");
}

async function compressImage(file, maxW=1280, quality=0.75){
  const img = document.createElement("img");
  const url = URL.createObjectURL(file);
  img.src = url;
  await new Promise(res => img.onload = res);

  const scale = Math.min(1, maxW / img.width);
  const w = Math.round(img.width * scale);
  const h = Math.round(img.height * scale);

  const canvas = document.createElement("canvas");
  canvas.width = w; canvas.height = h;
  const ctx = canvas.getContext("2d");
  ctx.drawImage(img, 0, 0, w, h);

  URL.revokeObjectURL(url);

  const blob = await new Promise(res =>
    canvas.toBlob(res, "image/jpeg", quality)
  );

  if (!blob) return file;
  return new File([blob], file.name.replace(/\.\w+$/, ".jpg"), { type:"image/jpeg" });
}

/* ================= ‚úÖ ADDED: helper delete old storage files by URL (best-effort) ================= */
async function deleteFilesByUrls(urls){
  if(!urls || !Array.isArray(urls) || urls.length === 0) return;
  for(const url of urls){
    try{
      const ref = storage.refFromURL(url);
      await ref.delete();
    }catch(e){
      // –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º: —Ñ–∞–π–ª –º–æ–≥ –±—ã—Ç—å —É–∂–µ —É–¥–∞–ª—ë–Ω/–Ω–µ—Ç –ø—Ä–∞–≤/–∏ —Ç.–¥.
    }
  }
}

/* ================= UPLOAD (student) ================= */
async function submitHW(input, group, student, stage, lesson, hw) {
  const files = Array.from(input.files || []);

  if (files.length === 0) {
    alert("At least one photo is required.");
    return;
  }

  if (files.length > 4) {
    alert("‚ùå You can upload maximum 4 photos.\nPlease select up to 4 images.");
    input.value = "";
    return;
  }

  let uploadedUrls = [];

  for (const file of files) {
    const filePath =
      `submissions/${safe(group)}/${safe(student)}/${safe(stage)}/${safe(lesson)}/${safe(hw)}/${Date.now()}_${safe(file.name)}`;

    const ref = storage.ref(filePath);
    const small = await compressImage(file);

    try {
      await ref.put(small);
      const url = await ref.getDownloadURL();
      uploadedUrls.push(url);
    } catch (e) {
      alert("Upload failed: " + (e.message || e));
      input.value = "";
      return;
    }
  }

  await db.ref(`submissions/${group}/${student}/${stage}/${lesson}/${hw}`).set({
    files: uploadedUrls,
    time: Date.now()
  });

  // ‚úÖ –≤–∞–∂–Ω–æ: –æ—á–∏—Å—Ç–∏—Ç—å input, —á—Ç–æ–±—ã WebView –Ω–µ ‚Äú–ø–æ–º–Ω–∏–ª‚Äù —Å—Ç–∞—Ä—ã–µ —Ñ–∞–π–ª—ã
  input.value = "";

  // ‚úÖ ADDED: –æ—Å—Ç–∞—ë–º—Å—è –Ω–∞ —Ç–æ–º –∂–µ —É—Ä–æ–∫–µ (–Ω–µ —É—Ö–æ–¥–∏–º –≤ home)
  await showHomework(group, student, stage, lesson);

  alert("Submitted successfully ‚úî");
}

/* ================= ‚úÖ ADDED: REPLACE PHOTOS ================= */
async function replaceHW(input, group, student, stage, lesson, hw) {
  const files = Array.from(input.files || []);

  if (files.length === 0) {
    alert("At least one photo is required.");
    return;
  }

  if (files.length > 4) {
    alert("‚ùå You can upload maximum 4 photos.\nPlease select up to 4 images.");
    input.value = "";
    return;
  }

  // 1) –±–µ—Ä—ë–º —Å—Ç–∞—Ä—ã–µ —É—Ä–ª—ã –∏–∑ DB
  const snap = await db.ref(`submissions/${group}/${student}/${stage}/${lesson}/${hw}`).once("value");
  const old = snap.val();
  const oldUrls = old && Array.isArray(old.files) ? old.files : [];

  // 2) —É–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ —Ñ–∞–π–ª—ã –∏–∑ Storage (best-effort)
  await deleteFilesByUrls(oldUrls);

  // 3) –≥—Ä—É–∑–∏–º –Ω–æ–≤—ã–µ
  let uploadedUrls = [];

  for (const file of files) {
    const filePath =
      `submissions/${safe(group)}/${safe(student)}/${safe(stage)}/${safe(lesson)}/${safe(hw)}/${Date.now()}_${safe(file.name)}`;

    const ref = storage.ref(filePath);
    const small = await compressImage(file);

    try {
      await ref.put(small);
      const url = await ref.getDownloadURL();
      uploadedUrls.push(url);
    } catch (e) {
      alert("Upload failed: " + (e.message || e));
      input.value = "";
      return;
    }
  }

  await db.ref(`submissions/${group}/${student}/${stage}/${lesson}/${hw}`).set({
    files: uploadedUrls,
    time: Date.now()
  });

  input.value = "";
  await showHomework(group, student, stage, lesson);
  alert("Replaced successfully ‚úî");
}

/* ================= ADMIN ================= */
function login(){
  const u=prompt("Login");
  const p=prompt("Password");
  if((u==="Teacher1"&&p==="Admin1")||(u==="Assistant1"&&p==="Admin2")) admin();
  else alert("Wrong credentials");
}

function admin(){
  setNav("admin", {});
  let h = `<button class="back" onclick="home()">Back</button><h3>Admin Panel</h3>`;

  Object.keys(GROUPS).forEach(g=>{
    h += `
      <div class="card">
        <div style="font-weight:700;margin-bottom:8px;color:#111">${g}</div>
        <button class="primary" onclick="adminGroup('${g}')">Open</button>
        <button class="danger" onclick="clearGroup('${g}')">Clear Group Files</button>
      </div>
    `;
  });

  app.innerHTML = h;
}

function adminGroup(group){
  setNav("adminGroup", { group });
  let h = `
    <button class="back" onclick="admin()">Back</button>
    <h3>${group}</h3>
    <h4>Select Stage</h4>
  `;

  Object.keys(STAGES).forEach(stage=>{
    h += `
      <div class="card">
        <button class="primary" onclick="adminStageSelect('${group}','${stage}')">
          ${stage}
        </button>
      </div>
    `;
  });

  app.innerHTML = h;
}

function adminStageSelect(group, stage){
  setNav("adminStageSelect", { group, stage });
  let h = `
    <button class="back" onclick="adminGroup('${group}')">Back</button>
    <h3>${group}</h3>
    <h4>${stage}</h4>
    <h4>Select Lesson</h4>
  `;

  Object.keys(STAGES[stage]).forEach(lesson=>{
    h += `
      <div class="card">
        <button class="secondary" onclick="adminLessonView('${group}','${stage}','${lesson}')">
          ${lesson}
        </button>
      </div>
    `;
  });

  app.innerHTML = h;
}

async function adminLessonView(group, stage, lesson){
  setNav("adminLessonView", { group, stage, lesson });

  let h = `
    <button class="back" onclick="adminStageSelect('${group}','${stage}')">Back</button>

    <h3>${group}</h3>
    <h4>${stage} / ${lesson}</h4>

    <button class="secondary" onclick="exportLessonCSV('${group}','${stage}','${lesson}')">
      üì§ Export lesson to CSV
    </button>
  `;

  for (const student of GROUPS[group]) {
    h += `<div class="card"><b>${student}</b><br>`;

    for (const hw of STAGES[stage][lesson]) {
      const snap = await db
        .ref(`submissions/${group}/${student}/${stage}/${lesson}/${hw}`)
        .once("value");

      const d = snap.val();
      const ok = d && Array.isArray(d.files) && d.files.length > 0;

      h += `
        <div class="hw">
          ${
            ok
              ? `<span class="green">Yes ‚Äî ${hw}</span>`
              : `<span class="red">No ‚Äî ${hw}</span>`
          }
          ${
            ok
              ? d.files.map(url =>
                  `<a href="${url}" target="_blank">üì∑</a>`
                ).join(" ")
              : ''
          }
        </div>
      `;
    }

    h += `</div>`;
  }

  app.innerHTML = h;
}

function clearGroup(group){
  if(!confirm("Clear ALL files for this group?"))return;
  db.ref(`submissions/${group}`).remove().then(()=>alert("Cleared"));
}

async function exportLessonCSV(group, stage, lesson){
  const students = GROUPS[group];
  const homeworks = STAGES[stage][lesson];

  let csv = [];
  csv.push(["Student Name", ...homeworks].join(","));

  for (const student of students) {
    let row = [student];

    for (const hw of homeworks) {
      const snap = await db
        .ref(`submissions/${group}/${student}/${stage}/${lesson}/${hw}`)
        .once("value");

      const d = snap.val();
      const yesNo =
        d && Array.isArray(d.files) && d.files.length > 0
          ? "Yes"
          : "No";

      row.push(yesNo);
    }

    csv.push(row.join(","));
  }

  const blob = new Blob([csv.join("\n")], { type: "text/csv" });
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = `${group} - ${stage} - ${lesson}.csv`;
  a.click();

  URL.revokeObjectURL(url);
}

/* ‚úÖ CHANGED: –≤–º–µ—Å—Ç–æ home() ‚Äî –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —ç–∫—Ä–∞–Ω–∞, –∏–Ω–∞—á–µ home */
home();
</script>
</body>
</html>

























































































