<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Student Statista</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<style>
body{margin:0;font-family:Arial;background:#f4f6fb}
header{background:#1e88e5;color:#fff;padding:15px;text-align:center;font-size:20px}
.container{max-width:1100px;margin:20px auto;padding:10px}
.card{background:#fff;border-radius:8px;padding:15px;margin-bottom:10px}
button{padding:8px 14px;border:none;border-radius:6px;cursor:pointer}
.primary{background:#1e88e5;color:#fff}
.back{background:#555;color:#fff;margin-bottom:10px}
.red{color:#c62828;font-weight:bold}
.green{color:#2e7d32;font-weight:bold}
.task{display:flex;justify-content:space-between;align-items:center}
img{max-width:120px;border-radius:6px;margin-top:6px}
input[type=file]{display:none}
input[type=date]{padding:6px}
hr{border:none;border-top:1px solid #ddd;margin:10px 0}
</style>
</head>

<body>
<header>Student Statista</header>
<div class="container" id="app"></div>

<script>
/* ================= FIREBASE ================= */
firebase.initializeApp({
  apiKey: "AIzaSyDJDVZazGiEUshVicJX8ObvxIjDPgA5rTo",
  authDomain: "studentstatista.firebaseapp.com",
  databaseURL: "https://studentstatista-default-rtdb.firebaseio.com",
  projectId: "studentstatista"
});
const db = firebase.database();

/* ================= CONFIG ================= */
const IMGBB_KEY = "be4e74e3246530deeb9dd1d7cfb31a3d";

const TASKS=[
"Dictation","Reading Test Bank","Podcast","Writing task 1","Writing task 2",
"Speaking Part 1","Speaking Part 2","Speaking Part 3",
"Listening Strategies","Listening Practice","Reading Practice",
"Listening Made easy","Cambridge Listening","Cambridge Reading",
"Cambridge Writing","TED Podcasts","Vocab for ielts book"
];

const GROUPS = {

  "GROUP IELTS M/W/F 9:00": [
    "HOSHIMOVA NILUFAR",
    "JURAYEVA AZIZA",
    "MAHMUDOV SUNNAT",
    "MUHIDDINOVA MAHBUBA",
    "NORBOYEV SHOHJAXON",
    "OCHILOV LOCHINBEK",
    "ORALOVA SHOHINUR",
    "RAVSHANOVA ZAYNAB",
    "TOSHPULATOV ABBOS"
  ],

  "GROUP IELTS 17:00 MWF": [
    "ABDURAHIMOVA ZILOLA",
    "ALIMOV BEHRUZ",
    "ANVAROVA RUXSHONA",
    "ASADOV SARDOR",
    "BAXRONOVA FAYRUZA",
    "GAFURJONOV ULUGBEK",
    "ISMOILOV ISMOIL",
    "JULIBOYEVA ZEBO",
    "KOZIMJONOVA DURDONA",
    "QIZIMELIKUZIYEVA RUXSHONA",
    "NIGMATOV ABDURAHIM",
    "RAHMATULLAYEV BEXRUZ",
    "TALABOV SAUD",
    "XISLATULLAYEV JAVOXIR",
    "XODJAYEVA LAZIZA",
    "YORMATOV MIRABROR"
  ],

  "GROUP IELTS T/T/S 9:00": [
    "SAIDUSMONOVA MADINA",
    "SOBIROVA MARJONA",
    "TILLAYEV OYBEK",
    "TOSHTEMIROVA MUBORAK",
    "UMAROVA MOXIGUL"
  ],

  "GROUP IELTS 10:30 TTS": [
    "ADXAMOVA MUBINA",
    "BAXTIYOROVA NILUFAR",
    "ISAMATOVA LAYLO",
    "NOSIROVA LAZIZA",
    "QILICHOVA GULISTON"
  ],

  "GROUP IELTS T/T/S 14:00": [
    "ABDUAZIZOVA HABIBA",
    "ABDUJABBOROVA LOLA",
    "ABDUVALIYEVA OMINA",
    "ALISHEROV NURMUHAMMAD",
    "DJURAYEVA NURGUL",
    "ISLOMBEKOVA EZOZA",
    "ISMAILOVA EZOZA",
    "JORABEKOV AFZALBEK",
    "MAHMUDJONOV FAYZULLOH",
    "MIRAHMEDOVA MUSLIMA",
    "OLIMJONOVA DILNURA",
    "TOJIBOYEV MUXAMMAD",
    "UROLOV SIROJ",
    "XUDOYBERDIYEV QOSIMBEK"
  ],

  "GROUP IELTS 15:30 TTS": [
    "ABUBAKIROVA RAHIMA",
    "IMANKULOVA CHAROS",
    "ISLOMXOJAYEV YUNUS",
    "KAYUMKHAJAYEVA JASMINA",
    "MAVLONBEKOV NURMUHAMMAD",
    "MIRAXMEDOVA ROBIYA",
    "MIRSAIDOVA MALIKA",
    "MIRSODIQOV MIRABROR",
    "QODIROV ABDUVALI",
    "QOSIMOVA NARGIZA",
    "RAVSHANOVA MUSLIMA",
    "SHARAXMEDOVA KAMILA",
    "SHERALIYEV ELSHOD",
    "TOGAYEVA SHAXINA",
    "UMARXONOVA JAVOHIRPOSHSHA",
    "YOLDASHEVA FARZONA",
    "ZOIRXOJAYEVA ROBIYA"
  ]

};

const app=document.getElementById("app");

/* ================= HOME ================= */
function home(){
app.innerHTML=`
<div class="card"><button class="primary" onclick="student()">Enter as Student</button></div>
<div class="card"><button class="primary" onclick="admin()">Teacher / Assistant</button></div>
`;
}

/* ================= STUDENT ================= */
function student(){
let h=`<button class="back" onclick="home()">Back</button><h3>Select group</h3>`;
Object.keys(GROUPS).forEach(g=>{
h+=`<div class="card"><button class="primary" onclick="students('${g}')">${g}</button></div>`;
});
app.innerHTML=h;
}

function students(group){
let h=`<button class="back" onclick="student()">Back</button><h3>${group}</h3>`;
GROUPS[group].forEach(s=>{
h+=`<div class="card"><button class="primary" onclick="tasks('${group}','${s}')">${s}</button></div>`;
});
app.innerHTML=h;
}

function tasks(group,student){
app.innerHTML=`<button class="back" onclick="students('${group}')">Back</button><h3>${student}</h3><div id="tasks"></div>`;
TASKS.forEach(t=>{
db.ref(`submissions/${group}/${student}/${t}`).once("value",snap=>{
let d=snap.val();
document.getElementById("tasks").innerHTML+=`
<div class="card task">
<div>
<b>${t}</b><br>
<span class="${d?'green':'red'}">${d?'Submitted':'Not submitted'}</span>
${d?`<img src="${d.url}">`:''}
</div>
<label class="primary">
Submit<input type="file" accept="image/*"
onchange="upload(this,'${group}','${student}','${t}')">
</label>
</div>`;
});
});
}

function upload(inp,g,s,t){
let fd=new FormData();
fd.append("image",inp.files[0]);
fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_KEY}`,{method:"POST",body:fd})
.then(r=>r.json())
.then(res=>{
db.ref(`submissions/${g}/${s}/${t}`).set({url:res.data.url,time:Date.now()})
.then(()=>tasks(g,s));
});
}

/* ================= ADMIN ================= */
function admin(){
let l=prompt("Login:");
let p=prompt("Password:");
if(!((l==="Teacher1"&&p==="Admin1")||(l==="Assistant1"&&p==="Admin2"))){
alert("Wrong credentials");return;
}

let h=`<button class="back" onclick="home()">Back</button>
<h3>Admin Panel</h3>

<label>From <input type="date" id="from"></label>
<label>To <input type="date" id="to"></label>
<button class="primary" onclick="loadAdmin()">Apply</button>
<hr>`;

Object.keys(GROUPS).forEach(g=>{
h+=`
<div class="card">
<b>${g}</b><br>
<button onclick="exportCSV('${g}')">Export CSV</button>
<button onclick="clearGroup('${g}')">Clear Group</button>
</div>`;
});
app.innerHTML=h;
loadAdmin();
}

function loadAdmin(){
let from=document.getElementById("from").valueAsNumber||0;
let to=document.getElementById("to").valueAsNumber||Date.now();
db.ref("submissions").once("value",snap=>{
let data=snap.val()||{};
Object.keys(data).forEach(g=>{
let block=document.createElement("div");
block.className="card";
block.innerHTML=`<h4>${g}</h4>`;
Object.keys(data[g]).forEach(s=>{
Object.keys(data[g][s]).forEach(t=>{
let r=data[g][s][t];
if(r.time>=from&&r.time<=to){
block.innerHTML+=`${s} — ${t} — <a href="${r.url}" target="_blank">view</a><br>`;
}
});
});
app.appendChild(block);
});
});
}

function exportCSV(group){
db.ref(`submissions/${group}`).once("value",snap=>{
let rows=["Student,Task,URL,Date"];
let d=snap.val()||{};
Object.keys(d).forEach(s=>{
Object.keys(d[s]).forEach(t=>{
let r=d[s][t];
rows.push(`${s},${t},${r.url},${new Date(r.time).toLocaleString()}`);
});
});
let blob=new Blob([rows.join("\n")],{type:"text/csv"});
let a=document.createElement("a");
a.href=URL.createObjectURL(blob);
a.download=group+".csv";
a.click();
});
}

function clearGroup(group){
if(confirm("Clear all submissions for "+group+"?")){
db.ref("submissions/"+group).remove().then(()=>admin());
}
}

home();
</script>
</body>
</html>
